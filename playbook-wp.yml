---

- name: Déploiement sur l'infra
  hosts: all
  tasks:
    - name: Tâches all-nodes
      include_tasks: tasks/all-nodes.yml

- name: Déploiement sur les serveurs web
  hosts: web
  roles:
    - nfs
  vars:
    - nfs_function: server
    - nfs_exports:
      - fs: "{{ wordpress_path }}"
        client: "{{ hostvars[groups['php'][0]]['ansible_host'] }}"
        options: rw,sync,fsid=0,no_subtree_check
  tasks:
    - name: Tâches web Apache
      include_tasks: tasks/web-apache.yml
    - name: Tâches web WP
      include_tasks: tasks/web-wp.yml
  handlers:
  # sudo systemctl restart nfs-kernel-server
  - name: Redémarrer nfs-kernel-server
    service: 
      name: nfs-kernel-server
      state: restarted
  # sudo systemctl restart apache2
  - name: Redémarrer Apache
    service: 
      name: apache2
      state: restarted

- name: Déploiement sur les serveurs PHP
  hosts: php
  roles:
    - nfs
  vars:
    - nfs_function: client
    - nfs_mounts:
      - server: "{{ hostvars[groups['web'][0]]['ansible_host'] }}"
        server_fs: "{{ wordpress_path }}"
        mountpoint: "{{ wordpress_path }}"
        options: defaults
  tasks:
    - name: Tâches PHP-FPM
      include_tasks: tasks/php-fpm.yml
  handlers:
  - name: Redémarrer PHP-FPM
    service: 
      name: "php{{ php_version.stdout }}-fpm"
      state: restarted

- name: Déploiement sur les serveurs DB
  hosts: db
  roles:
    - lukasic.mariadb
  vars:
    mariadb_server_params:
      - option: "bind-address"
        section: "mysqld"
        value: "0.0.0.0"
    mariadb_databases:
      - "{{ wordpress_db }}"
    mariadb_users:
      - host: "%"
        name: "{{ wordpress_db_user }}"
        password: "{{ wordpress_db_pass }}"
        priv: "{{ wordpress_db }}.*:ALL"